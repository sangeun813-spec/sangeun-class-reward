<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>ìš°ë¦¬ ë°˜ ì¹­ì°¬ ë³´ìƒ í”„ë¡œê·¸ë¨</title>
<style>
  :root{
    --bg:#f8fbff;
    --primary:#3b82f6;
    --secondary:#22c55e;
    --accent:#f59e0b;
    --danger:#ef4444;
    --ink:#0f172a;
    --muted:#64748b;
    --card:#ffffff;
    --border:#e5e7eb;
    --gem:#06b6d4;
    --purple:#8b5cf6;
  }
  *{box-sizing:border-box;}
  html,body{margin:0;padding:0;background:var(--bg);color:var(--ink);font-family:'Pretendard', 'Segoe UI', system-ui, -apple-system, Arial, sans-serif;font-size:18px}
  h1,h2,h3{margin:0 0 .5rem 0}
  .app {max-width:1200px;margin:0 auto;padding:16px;}
  /* Header */
  .header{
    background:linear-gradient(135deg, #93c5fd 0%, #60a5fa 60%, #34d399 100%);
    border-radius:16px;color:#fff;padding:20px;display:flex;gap:16px;align-items:center;justify-content:space-between;flex-wrap:wrap;
  }
  .brand{display:flex;align-items:center;gap:14px}
  .brand .logo{font-size:42px}
  .brand .title{font-size:28px;font-weight:800;line-height:1.1}
  .class-stats{display:flex;gap:16px;align-items:center;flex-wrap:wrap}
  .stat-card{
    background:rgba(255,255,255,.2);border:2px solid rgba(255,255,255,.5);
    padding:12px 16px;border-radius:14px;min-width:230px;display:flex;gap:12px;align-items:center
  }
  .stat-icon{font-size:38px}
  .stat-body{line-height:1.1}
  .stat-value{font-size:30px;font-weight:900}
  .stat-sub{font-size:14px;opacity:.95}
  .gem-progress{
    width:240px;background:rgba(255,255,255,.25);height:16px;border-radius:9999px;overflow:hidden;border:1px solid rgba(255,255,255,.45)
  }
  .gem-progress > div{
    height:100%;background:#fff
      linear-gradient(90deg, rgba(255,255,255,.9) 0, rgba(255,255,255,.5) 80%),
      linear-gradient(90deg, #22c55e, #06b6d4);
    width:0%;
  }

  /* Layout */
  .layout{display:grid;grid-template-columns:340px 1fr;gap:16px;margin-top:16px}
  @media (max-width:960px){ .layout{grid-template-columns:1fr} }

  /* Left panel (controls) */
  .panel{
    background:var(--card);border:2px solid var(--border);border-radius:16px;padding:16px
  }
  .section + .section{margin-top:16px;padding-top:16px;border-top:2px dashed var(--border)}
  .section h3{font-size:20px}
  label{display:block;margin:.5rem 0 .25rem .25rem;font-weight:700}
  input[type="text"], input[type="number"], select, textarea{
    width:100%;padding:12px 14px;border-radius:12px;border:2px solid var(--border);
    font-size:18px;background:#fff;outline:none;
  }
  textarea{min-height:78px;resize:vertical}
  .btn{
    display:inline-flex;align-items:center;justify-content:center;gap:8px;
    padding:12px 16px;border-radius:12px;border:0;cursor:pointer;
    font-weight:900;font-size:18px;transition:transform .05s ease;user-select:none;
  }
  .btn:active{transform:translateY(1px)}
  .btn-primary{background:var(--primary);color:#fff}
  .btn-secondary{background:var(--secondary);color:#fff}
  .btn-accent{background:var(--accent);color:#222}
  .btn-danger{background:var(--danger);color:#fff}
  .btn-ghost{background:#eef2ff;color:#312e81}
  .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  .chips{display:flex;gap:8px;flex-wrap:wrap}
  .chip{
    background:#eef2ff;border:2px solid #c7d2fe;color:#312e81;padding:8px 12px;border-radius:9999px;cursor:pointer;font-weight:700
  }
  .chip.active{background:#a78bfa;border-color:#7c3aed;color:#fff}
  .small{font-size:14px;color:var(--muted)}
  .space{height:8px}

  /* Student grid */
  .student-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:12px}
  .card{
    background:var(--card);border:2px solid var(--border);border-radius:16px;padding:14px;display:flex;flex-direction:column;gap:10px;
  }
  .card-header{display:flex;align-items:center;justify-content:space-between}
  .student-name{font-size:22px;font-weight:900}
  .points{font-size:28px;font-weight:900;color:var(--primary)}
  .progress{height:12px;background:#f1f5f9;border-radius:9999px;overflow:hidden;border:1px solid var(--border)}
  .progress > div{height:100%;background:linear-gradient(90deg, #f59e0b, #ef4444);width:0%}
  .quick{display:flex;gap:8px}
  .quick .btn{flex:1}

  .history{background:#f8fafc;border:2px dashed var(--border);border-radius:12px;padding:10px;max-height:140px;overflow:auto}
  .history-item{font-size:14px;margin-bottom:6px}
  .history-item b{color:#111}

  .empty{padding:20px;border:2px dashed var(--border);border-radius:12px;text-align:center;color:var(--muted)}
  .tools .btn{width:100%}

  /* Overlay for celebrations */
  .celebrate{
    position:fixed;inset:0;display:none;align-items:center;justify-content:center;z-index:1000;
    background:rgba(0,0,0,.35);backdrop-filter:blur(2px)
  }
  .celebrate.show{display:flex}
  .celebrate .box{
    background:#fff;border-radius:18px;border:4px solid #fcd34d;max-width:560px;
    padding:20px;text-align:center;box-shadow:0 10px 30px rgba(0,0,0,.25)
  }
  .celebrate .title{font-size:30px;font-weight:900;margin-bottom:8px}
  .celebrate .msg{font-size:20px}
  .confetti{
    position:fixed;inset:0;pointer-events:none;overflow:hidden;z-index:1001
  }
  .confetti span{
    position:absolute;font-size:28px;animation:fall linear forwards;opacity:.95
  }
  @keyframes fall{
    from{transform:translateY(-10vh) rotate(0deg)}
    to{transform:translateY(110vh) rotate(540deg)}
  }

  .goal-item{
    display:flex;align-items:center;gap:8px;background:#ecfeff;border:2px solid #a5f3fc;border-radius:12px;padding:10px
  }
  .goal-item input{flex:1}
</style>
</head>
<body>
  <div class="app">
    <div class="header">
      <div class="brand">
        <div class="logo">ğŸ†</div>
        <div class="title">ìš°ë¦¬ ë°˜ ì¹­ì°¬ ë³´ìƒ í”„ë¡œê·¸ë¨</div>
      </div>
      <div class="class-stats">
        <div class="stat-card">
          <div class="stat-icon">ğŸ’</div>
          <div class="stat-body">
            <div class="stat-value"><span id="gemCount">0</span> ê°œ</div>
            <div class="stat-sub">í•™ê¸‰ ë³´ì„</div>
            <div class="space"></div>
            <div class="gem-progress"><div id="gemProgress"></div></div>
            <div class="small">ë‹¤ìŒ ë³´ì„ê¹Œì§€ <b id="toNextGem">10</b>ì </div>
          </div>
        </div>
        <div class="stat-card">
          <div class="stat-icon">ğŸ§®</div>
          <div class="stat-body">
            <div class="stat-value"><span id="studentCount">0</span> ëª…</div>
            <div class="stat-sub">í•™ìƒ ìˆ˜</div>
          </div>
        </div>
      </div>
    </div>

    <div class="layout">
      <!-- LEFT PANEL -->
      <div class="panel">
        <div class="section">
          <h3>í•™ìƒ ì¶”ê°€</h3>
          <label>ì´ë¦„ (ì‰¼í‘œë¡œ ì—¬ëŸ¬ ëª… ì¶”ê°€)</label>
          <input id="addNames" type="text" placeholder="ì˜ˆ: ê¹€ì¹­ì°¬, ì´ì¹­ì°¬, ë°•ì¹­ì°¬"/>
          <div class="row" style="margin-top:8px">
            <button class="btn btn-secondary" id="btnAddStudents">+ í•™ìƒ ì¶”ê°€</button>
          </div>
        </div>

        <div class="section">
          <h3>ì ìˆ˜ ë¶€ì—¬</h3>
          <label>í•™ìƒ ì„ íƒ</label>
          <select id="selStudent"></select>
          <label>í–‰ë™ ë©”ëª¨</label>
          <input id="inpBehavior" type="text" placeholder="ì˜ˆ: ìˆ™ì œë¥¼ ì„±ì‹¤íˆ ì˜í–ˆì–´ìš”"/>
          <label>ì ìˆ˜</label>
          <input id="inpPoints" type="number" min="1" step="1" value="3"/>
          <div class="row" style="margin-top:10px">
            <button class="btn btn-primary" id="btnGive">âœ… ì ìˆ˜ ì£¼ê¸°</button>
            <button class="btn btn-ghost" id="btnPlus1">+1</button>
            <button class="btn btn-ghost" id="btnPlus3">+3</button>
            <button class="btn btn-ghost" id="btnPlus5">+5</button>
          </div>

          <div class="space"></div>
          <div class="small">â€» ë¹ ë¥´ê²Œ ì‚¬ìš©í•˜ë ¤ë©´ ì•„ë˜ í–‰ë™ í…œí”Œë¦¿ì„ ë§Œë“¤ì–´ ë‘ì„¸ìš”.</div>
          <div class="chips" id="templateChips"></div>
          <div class="row" style="margin-top:8px">
            <input id="inpNewTemplate" type="text" placeholder="ìƒˆ í…œí”Œë¦¿ ì˜ˆ: ë°œí‘œë¥¼ ë˜ë°•ë˜ë°• í–ˆì–´ìš”"/>
            <button class="btn btn-accent" id="btnAddTemplate">+ í…œí”Œë¦¿ ì¶”ê°€</button>
          </div>
        </div>

        <div class="section">
          <h3>ë³´ì„ ëª©í‘œ (50, 100, 150ê°œâ€¦)</h3>
          <div id="goalList" class="column" style="display:flex;flex-direction:column;gap:8px"></div>
          <div class="row" style="margin-top:10px">
            <button class="btn btn-ghost" id="btnAddGoal">+ ë‹¤ìŒ êµ¬ê°„ ëª©í‘œ ì¶”ê°€</button>
          </div>
        </div>

        <div class="section tools">
          <h3>ì„¤ì • / ê´€ë¦¬</h3>
          <button class="btn btn-ghost" id="btnExport">ğŸ“¤ ë°ì´í„° ë‚´ë³´ë‚´ê¸°</button>
          <input id="fileImport" type="file" accept="application/json" style="display:none"/>
          <button class="btn btn-ghost" id="btnImport">ğŸ“¥ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°</button>
          <button class="btn btn-danger" id="btnReset">â™»ï¸ ì „ì²´ ì´ˆê¸°í™”</button>
        </div>
      </div>

      <!-- RIGHT: STUDENTS -->
      <div class="panel">
        <div class="section">
          <h3>í•™ìƒ ëª©ë¡</h3>
          <div id="studentGrid" class="student-grid"></div>
          <div id="emptyStudents" class="empty" style="display:none">í•™ìƒì„ ë¨¼ì € ì¶”ê°€í•´ ì£¼ì„¸ìš”.</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Celebration Overlay -->
  <div id="celebrate" class="celebrate" role="dialog" aria-live="polite">
    <div class="box">
      <div class="title">ğŸ‰ ì¶•í•˜í•©ë‹ˆë‹¤!</div>
      <div id="celebrateMsg" class="msg"></div>
      <div class="space"></div>
      <button id="btnCloseCelebrate" class="btn btn-primary">ë‹«ê¸°</button>
    </div>
  </div>
  <div id="confetti" class="confetti" aria-hidden="true"></div>

<script>
/** =========================
 *  ìƒíƒœ ê´€ë¦¬ (localStorage)
 *  ========================= */
const STORE_KEY = 'classRewardState_v1';

const defaultState = {
  students: [], // {id, name, points, history:[{t, behavior, points}]}
  class: {
    gems: 0,
    unbankedPoints: 0, // 0~9: ë‹¤ìŒ ë³´ì„ê¹Œì§€ ë‚¨ì€ í•©ê³„
    goals: {} // { "50": "ê³¼ì íŒŒí‹°", "100": "íŒŒìë§ˆ íŒŒí‹°" }
  },
  templates: ["ìˆ™ì œë¥¼ ì„±ì‹¤íˆ ì˜í–ˆì–´ìš”", "ë°œí‘œë¥¼ ë˜ë°•ë˜ë°• í° ëª©ì†Œë¦¬ë¡œ í–ˆì–´ìš”", "ì¹œêµ¬ë¥¼ ë„ì™€ì¤¬ì–´ìš”"]
};

let state = loadState();

function saveState(){
  localStorage.setItem(STORE_KEY, JSON.stringify(state));
}
function loadState(){
  try{
    const raw = localStorage.getItem(STORE_KEY);
    if(!raw) return structuredClone(defaultState);
    const parsed = JSON.parse(raw);
    // ë§ˆì´ê·¸ë ˆì´ì…˜/ê¸°ë³¸ê°’ ë³´ì •
    if(!parsed.class) parsed.class = {gems:0, unbankedPoints:0, goals:{}};
    if(!parsed.templates) parsed.templates = defaultState.templates;
    parsed.students = (parsed.students||[]).map(s=>({
      id: s.id ?? crypto.randomUUID(),
      name: s.name ?? 'ì´ë¦„',
      points: Number(s.points||0),
      history: Array.isArray(s.history) ? s.history : []
    }));
    return parsed;
  }catch(e){
    console.warn('Failed to load state, using default.', e);
    return structuredClone(defaultState);
  }
}

/** =========================
 *  ìœ í‹¸
 *  ========================= */
function fmtDate(ts){
  const d = new Date(ts);
  const m = d.getMonth()+1, day = d.getDate();
  const hh = String(d.getHours()).padStart(2,'0');
  const mm = String(d.getMinutes()).padStart(2,'0');
  return `${m}/${day} ${hh}:${mm}`;
}
function nextMultiple(base, step){
  return Math.ceil((base+1)/step)*step;
}

/** =========================
 *  ì˜¤ë””ì˜¤(íŒ¡íŒŒë ˆ)
 *  ========================= */
let audioCtx;
function ensureAudio(){
  if(!audioCtx) audioCtx = new (window.AudioContext||window.webkitAudioContext)();
}
function playFanfare(){
  ensureAudio();
  const ctx = audioCtx;
  const seq = [
    {t:0.00, f:523.25, d:0.20}, // C5
    {t:0.22, f:659.25, d:0.20}, // E5
    {t:0.44, f:783.99, d:0.20}, // G5
    {t:0.68, f:1046.50, d:0.35}, // C6
  ];
  seq.forEach(n=>{
    const o = ctx.createOscillator();
    const g = ctx.createGain();
    o.type = 'triangle';
    o.frequency.value = n.f;
    o.connect(g); g.connect(ctx.destination);
    const now = ctx.currentTime + n.t;
    g.gain.setValueAtTime(0.0001, now);
    g.gain.exponentialRampToValueAtTime(0.4, now+0.02);
    g.gain.exponentialRampToValueAtTime(0.0001, now + n.d);
    o.start(now); o.stop(now + n.d + 0.02);
  });
}

/** =========================
 *  ì»¨í˜í‹° & ì¶•í•˜
 *  ========================= */
const $cele = document.getElementById('celebrate');
const $celeMsg = document.getElementById('celebrateMsg');
const $confetti = document.getElementById('confetti');
document.getElementById('btnCloseCelebrate').onclick = ()=> $cele.classList.remove('show');

function launchConfetti(message="ì¶•í•˜í•©ë‹ˆë‹¤!"){
  $celeMsg.textContent = message;
  $cele.classList.add('show');
  $confetti.innerHTML = '';
  const colors = ['ğŸ‰','ğŸŠ','ğŸ’¥','âœ¨','ğŸ’«','ğŸŒŸ','ğŸ’','ğŸˆ'];
  const count = 80;
  for(let i=0;i<count;i++){
    const s = document.createElement('span');
    s.textContent = colors[Math.floor(Math.random()*colors.length)];
    s.style.left = Math.random()*100 + 'vw';
    s.style.animationDuration = (2 + Math.random()*2) + 's';
    s.style.animationDelay = (Math.random()*0.5) + 's';
    $confetti.appendChild(s);
  }
  playFanfare();
  // ìë™ ë‹«ê¸°(ì‚¬ìš©ì„±): 3.5ì´ˆ í›„ ì»¨í˜í‹° ì‚­ì œ, ì˜¤ë²„ë ˆì´ ìœ ì§€(ë‹«ê¸° ë²„íŠ¼)
  setTimeout(()=>{ $confetti.innerHTML=''; }, 3500);
}

/** =========================
 *  ë³´ì„/ì ìˆ˜ ë¡œì§
 *  ========================= */
function addPoints(studentId, deltaPoints, behaviorNote){
  if(deltaPoints <= 0) return; // ë³¸ ì•±ì€ ê°€ê° ëŒ€ì‹  'ê°€ì‚°' ì¤‘ì‹¬

  const s = state.students.find(s=>s.id === studentId);
  if(!s) return;

  const prev = s.points;
  s.points += deltaPoints;
  s.history.unshift({t:Date.now(), behavior:behaviorNote||'ì¹­ì°¬ í¬ì¸íŠ¸', points:deltaPoints});
  // í•™ìƒ ê°œì¸ 50ì  ë‹¨ìœ„ ì¶•í•˜ ì²´í¬
  triggerStudentMilestones(s.name, prev, s.points);

  // í•™ê¸‰: ê°œë³„ ì ìˆ˜ í•© 10ì ë‹¹ ë³´ì„ 1ê°œ
  let carry = state.class.unbankedPoints + deltaPoints;
  const addGems = Math.floor(carry / 10);
  state.class.unbankedPoints = carry % 10;
  const prevGems = state.class.gems;
  state.class.gems += addGems;
  // ë³´ì„ 50ê°œ ë‹¨ìœ„ ëª©í‘œ ì²´í¬
  if(addGems > 0){
    triggerGemMilestones(prevGems, state.class.gems);
  }

  saveState();
  render();
}

function triggerStudentMilestones(name, oldPts, newPts){
  const startK = Math.floor(oldPts/50)+1;
  const endK = Math.floor(newPts/50);
  for(let k=startK; k<=endK; k++){
    const milestone = 50*k;
    launchConfetti(`ğŸ‰ ${name} í•™ìƒì˜ ì ìˆ˜ê°€ ${milestone}ì ì´ ë˜ì—ˆì–´ìš”! ëŒ€ë‹¨í•´ìš”!`);
  }
}

function triggerGemMilestones(oldGems, newGems){
  const startK = Math.floor(oldGems/50)+1;
  const endK = Math.floor(newGems/50);
  for(let k=startK; k<=endK; k++){
    const milestone = 50*k;
    const goalText = state.class.goals[milestone] || '';
    launchConfetti(`ğŸ’ ë³´ì„ì´ ${milestone}ê°œê°€ ë˜ì—ˆì–´ìš”! ${goalText ? 'ëª©í‘œ: ' + goalText : 'ìƒˆë¡œìš´ ëª©í‘œë¥¼ ì •í•´ë³¼ê¹Œìš”?'}`);
    // ëª©í‘œê°€ ì—†ë‹¤ë©´ ì¦‰ì‹œ ì…ë ¥ ì•ˆë‚´
    if(!goalText){
      setTimeout(()=> {
        const t = prompt(`ë³´ì„ ${milestone}ê°œ ë‹¬ì„± ëª©í‘œë¥¼ ì…ë ¥í•˜ì„¸ìš” (ì˜ˆ: ê³¼ì íŒŒí‹° í•˜ê¸°)`, '');
        if(t && t.trim()){
          state.class.goals[milestone] = t.trim();
          saveState(); renderGoals();
        }
      }, 400);
    }
  }
}

/** =========================
 *  ë Œë”ë§
 *  ========================= */
const $selStudent = document.getElementById('selStudent');
const $studentGrid = document.getElementById('studentGrid');
const $emptyStudents = document.getElementById('emptyStudents');
const $gemCount = document.getElementById('gemCount');
const $toNextGem = document.getElementById('toNextGem');
const $gemProgress = document.getElementById('gemProgress');
const $studentCount = document.getElementById('studentCount');

function render(){
  renderHeader();
  renderStudentSelector();
  renderStudents();
  renderTemplates();
  renderGoals();
}

function renderHeader(){
  $gemCount.textContent = state.class.gems;
  $studentCount.textContent = state.students.length;
  const left = 10 - (state.class.unbankedPoints || 0);
  $toNextGem.textContent = left;
  $gemProgress.style.width = ((state.class.unbankedPoints||0) / 10 * 100) + '%';
}

function renderStudentSelector(){
  $selStudent.innerHTML = '';
  if(state.students.length === 0){
    const op = document.createElement('option');
    op.textContent = 'í•™ìƒì„ ë¨¼ì € ì¶”ê°€í•˜ì„¸ìš”';
    op.value = '';
    $selStudent.appendChild(op);
  }else{
    state.students.forEach(s=>{
      const op = document.createElement('option');
      op.value = s.id;
      op.textContent = s.name;
      $selStudent.appendChild(op);
    });
  }
}

function renderStudents(){
  $studentGrid.innerHTML = '';
  if(state.students.length === 0){
    $emptyStudents.style.display = '';
    return;
  }
  $emptyStudents.style.display = 'none';

  state.students.forEach(s=>{
    const card = document.createElement('div');
    card.className = 'card';

    const head = document.createElement('div');
    head.className = 'card-header';
    const nm = document.createElement('div');
    nm.className = 'student-name';
    nm.textContent = s.name;
    const pts = document.createElement('div');
    pts.className = 'points';
    pts.textContent = s.points + ' ì ';
    head.appendChild(nm); head.appendChild(pts);

    const toNext = 50 - (s.points % 50 || 50);
    const prog = document.createElement('div');
    prog.className = 'progress';
    const bar = document.createElement('div');
    bar.style.width = ((s.points % 50)/50*100) + '%';
    prog.appendChild(bar);

    const quick = document.createElement('div');
    quick.className = 'quick';
    const b1 = mkBtn('+1', ()=> quickGive(s.id, 1));
    const b3 = mkBtn('+3', ()=> quickGive(s.id, 3));
    const b5 = mkBtn('+5', ()=> quickGive(s.id, 5));
    b1.classList.add('btn-ghost'); b3.classList.add('btn-ghost'); b5.classList.add('btn-ghost');
    quick.appendChild(b1); quick.appendChild(b3); quick.appendChild(b5);

    const smallInfo = document.createElement('div');
    smallInfo.className = 'small';
    smallInfo.textContent = `ë‹¤ìŒ ì¶•í•˜ê¹Œì§€ ${toNext}ì `;

    const hist = document.createElement('div');
    hist.className = 'history';
    if(s.history.length===0){
      hist.innerHTML = '<div class="small">ì•„ì§ ê¸°ë¡ì´ ì—†ì–´ìš”.</div>';
    }else{
      s.history.slice(0, 8).forEach(h=>{
        const it = document.createElement('div');
        it.className = 'history-item';
        it.innerHTML = `<b>+${h.points}ì </b> Â· ${h.behavior} <span class="small">(${fmtDate(h.t)})</span>`;
        hist.appendChild(it);
      });
    }

    // ì‚­ì œ ë²„íŠ¼
    const actions = document.createElement('div');
    actions.className = 'row';
    const del = document.createElement('button');
    del.className = 'btn btn-danger';
    del.textContent = 'ì‚­ì œ';
    del.onclick = ()=>{
      if(confirm(`"${s.name}" í•™ìƒì„ ì‚­ì œí• ê¹Œìš”? (ì ìˆ˜/ê¸°ë¡ë„ ì‚­ì œë©ë‹ˆë‹¤)`)){
        state.students = state.students.filter(x=>x.id!==s.id);
        saveState(); render();
      }
    };
    actions.appendChild(del);

    card.appendChild(head);
    card.appendChild(prog);
    card.appendChild(smallInfo);
    card.appendChild(quick);
    card.appendChild(hist);
    card.appendChild(actions);

    $studentGrid.appendChild(card);
  });

  function mkBtn(text, onClick){
    const b = document.createElement('button');
    b.className = 'btn';
    b.textContent = text;
    b.onclick = onClick;
    return b;
  }
}

function renderTemplates(){
  const wrap = document.getElementById('templateChips');
  wrap.innerHTML = '';
  const current = document.getElementById('inpBehavior').value.trim();
  state.templates.forEach((t, idx)=>{
    const span = document.createElement('span');
    span.className = 'chip' + (t===current ? ' active':'');
    span.textContent = t;
    span.onclick = ()=>{
      document.getElementById('inpBehavior').value = t;
      renderTemplates();
    }
    // ìš°í´ë¦­ìœ¼ë¡œ ì‚­ì œ
    span.oncontextmenu = (e)=>{
      e.preventDefault();
      if(confirm(`"${t}" í…œí”Œë¦¿ì„ ì‚­ì œí• ê¹Œìš”?`)){
        state.templates.splice(idx,1);
        saveState(); renderTemplates();
      }
    }
    wrap.appendChild(span);
  });
}

function renderGoals(){
  const list = document.getElementById('goalList');
  list.innerHTML = '';
  // ì •ë ¬ëœ í‚¤
  const keys = Object.keys(state.class.goals).map(k=>Number(k)).sort((a,b)=>a-b);
  keys.forEach(k=>{
    const row = document.createElement('div');
    row.className = 'goal-item';
    const tag = document.createElement('div');
    tag.style.fontWeight='900';
    tag.style.minWidth='90px';
    tag.textContent = `ğŸ’ ${k}ê°œ`;
    const inp = document.createElement('input');
    inp.type='text';
    inp.value = state.class.goals[k] || '';
    inp.placeholder = `ë³´ì„ ${k}ê°œ ë‹¬ì„± ëª©í‘œ`;
    inp.onchange = ()=> { state.class.goals[k] = inp.value; saveState(); }
    const del = document.createElement('button');
    del.className = 'btn btn-danger'; del.textContent = 'ì‚­ì œ';
    del.onclick = ()=>{
      if(confirm(`ë³´ì„ ${k}ê°œ ëª©í‘œë¥¼ ì‚­ì œí• ê¹Œìš”?`)){
        delete state.class.goals[k]; saveState(); renderGoals();
      }
    }
    row.appendChild(tag); row.appendChild(inp); row.appendChild(del);
    list.appendChild(row);
  });

  // ë‹¤ìŒ êµ¬ê°„ ì•ˆë‚´
  const next = Math.ceil((state.class.gems+1)/50)*50;
  const hint = document.createElement('div');
  hint.className = 'small';
  hint.style.marginTop='6px';
  hint.textContent = `ë‹¤ìŒ ëª©í‘œ êµ¬ê°„: ë³´ì„ ${next}ê°œ`;
  list.appendChild(hint);
}

/** =========================
 *  ì´ë²¤íŠ¸ ë°”ì¸ë”©
 *  ========================= */
document.getElementById('btnAddStudents').onclick = ()=>{
  const raw = document.getElementById('addNames').value.trim();
  if(!raw) return;
  const names = raw.split(',').map(s=>s.trim()).filter(Boolean);
  names.forEach(n=>{
    state.students.push({id:crypto.randomUUID(), name:n, points:0, history:[]});
  });
  document.getElementById('addNames').value = '';
  saveState(); render();
};

document.getElementById('btnGive').onclick = ()=>{
  const id = $selStudent.value;
  if(!id){ alert('í•™ìƒì„ ì„ íƒí•´ì£¼ì„¸ìš”.'); return; }
  const behavior = document.getElementById('inpBehavior').value.trim() || 'ì¹­ì°¬ í¬ì¸íŠ¸';
  const pts = Number(document.getElementById('inpPoints').value);
  if(!Number.isFinite(pts) || pts<=0){ alert('ì ìˆ˜ë¥¼ 1 ì´ìƒìœ¼ë¡œ ì…ë ¥í•˜ì„¸ìš”.'); return; }
  addPoints(id, pts, behavior);
};

document.getElementById('btnPlus1').onclick = ()=> quickToolbarGive(1);
document.getElementById('btnPlus3').onclick = ()=> quickToolbarGive(3);
document.getElementById('btnPlus5').onclick = ()=> quickToolbarGive(5);

function quickToolbarGive(delta){
  const id = $selStudent.value;
  if(!id){ alert('í•™ìƒì„ ì„ íƒí•´ì£¼ì„¸ìš”.'); return; }
  const behavior = document.getElementById('inpBehavior').value.trim() || `ë¹ ë¥¸ ì ìˆ˜ +${delta}`;
  addPoints(id, delta, behavior);
}

function quickGive(studentId, delta){
  // í˜„ì¬ ì„ íƒëœ í…œí”Œë¦¿/ë©”ëª¨ ê°€ì ¸ì˜¤ê¸°
  const behavior = document.getElementById('inpBehavior').value.trim() || `ë¹ ë¥¸ ì ìˆ˜ +${delta}`;
  addPoints(studentId, delta, behavior);
}

document.getElementById('btnAddTemplate').onclick = ()=>{
  const t = document.getElementById('inpNewTemplate').value.trim();
  if(!t) return;
  if(!state.templates.includes(t)) state.templates.push(t);
  document.getElementById('inpNewTemplate').value='';
  saveState(); renderTemplates();
};

document.getElementById('btnAddGoal').onclick = ()=>{
  const next = Math.ceil((state.class.gems+1)/50)*50;
  const t = prompt(`ë³´ì„ ${next}ê°œ ë‹¬ì„± ëª©í‘œë¥¼ ì…ë ¥í•˜ì„¸ìš”`, state.class.goals[next]||'');
  if(t && t.trim()){
    state.class.goals[next] = t.trim();
    saveState(); renderGoals();
  }
};

document.getElementById('btnExport').onclick = ()=>{
  const blob = new Blob([JSON.stringify(state,null,2)], {type:'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = 'class-reward-backup.json';
  a.click();
  URL.revokeObjectURL(url);
};

document.getElementById('btnImport').onclick = ()=>{
  document.getElementById('fileImport').click();
};
document.getElementById('fileImport').onchange = (e)=>{
  const file = e.target.files?.[0];
  if(!file) return;
  const reader = new FileReader();
  reader.onload = ()=>{
    try{
      const data = JSON.parse(reader.result);
      if(!confirm('ê°€ì ¸ì˜¤ì‹  ë°ì´í„°ë¡œ ë®ì–´ì“¸ê¹Œìš”? í˜„ì¬ ë°ì´í„°ëŠ” ì‚¬ë¼ì§‘ë‹ˆë‹¤.')) return;
      localStorage.setItem(STORE_KEY, JSON.stringify(data));
      state = loadState(); render();
    }catch(err){
      alert('ê°€ì ¸ì˜¤ê¸° ì‹¤íŒ¨: ì˜¬ë°”ë¥¸ JSON íŒŒì¼ì´ ì•„ë‹™ë‹ˆë‹¤.');
    }
  };
  reader.readAsText(file, 'utf-8');
  e.target.value = '';
};

document.getElementById('btnReset').onclick = ()=>{
  if(confirm('ì „ì²´ ë°ì´í„°ë¥¼ ì´ˆê¸°í™”í• ê¹Œìš”? (ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤)')){
    localStorage.removeItem(STORE_KEY);
    state = structuredClone(defaultState);
    render();
  }
};

/** =========================
 *  ì´ˆê¸° ë Œë”
 *  ========================= */
render();
</script>
</body>
</html>
